{% extends 'admin_portal/modern_base.html' %}
{% load static %}

{% block title %}{{ scoring_system.name }} - Scoring System - MindTrack{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Scoring System Header -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <div class="flex items-center">
                    <a href="{% url 'dashboard:scoring_management' %}" class="text-primary-600 hover:text-primary-900 mr-2">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h2 class="text-xl font-semibold text-gray-800">{{ scoring_system.name }}</h2>
                </div>
                <p class="mt-1 text-sm text-gray-600">{{ scoring_system.description }}</p>
            </div>
            <div class="mt-4 md:mt-0 flex space-x-3">
                <button id="calculateAllScoresBtn" data-system-id="{{ scoring_system.id }}" class="btn-animated inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-calculator mr-2"></i> Calculate All Scores
                </button>

                <div class="relative inline-block text-left">
                    <button type="button" id="exportDropdownButton" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-download mr-2"></i> Export
                        <i class="fas fa-chevron-down ml-2"></i>
                    </button>
                    <div id="exportDropdown" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10">
                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="exportDropdownButton">
                            {% if scoring_system.id %}
                            <a href="{% url 'dashboard:api_export_scores_csv' system_id=scoring_system.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-file-csv mr-2"></i> Export as CSV
                            </a>
                            <a href="{% url 'dashboard:api_export_scores_excel' system_id=scoring_system.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-file-excel mr-2"></i> Export as Excel
                            </a>
                            <a href="{% url 'dashboard:api_export_scores_pdf' system_id=scoring_system.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                                <i class="fas fa-file-pdf mr-2"></i> Export as PDF
                            </a>
                            {% else %}
                            <span class="block px-4 py-2 text-sm text-gray-500">Export options unavailable</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scoring System Details -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <!-- Basic Info -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-5 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Basic Information</h3>
        </div>
        <div class="p-5">
            <dl class="grid grid-cols-1 gap-x-4 gap-y-6">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Questionnaire</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if scoring_system.questionnaire %}
                        <a href="{% url 'surveys:survey_detail' pk=scoring_system.questionnaire.id %}" class="text-primary-600 hover:text-primary-900">
                            {{ scoring_system.questionnaire.title }}
                        </a>
                        {% else %}
                        <span class="text-gray-500">Not available</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Scoring Type</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if scoring_system.scoring_type %}
                            {% if scoring_system.get_scoring_type_display %}
                                {{ scoring_system.get_scoring_type_display }}
                            {% else %}
                                {{ scoring_system.scoring_type|title }}
                            {% endif %}
                        {% else %}
                            <span class="text-gray-500">Not specified</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Created By</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if scoring_system.created_by %}
                            {{ scoring_system.created_by.get_full_name|default:scoring_system.created_by.email }}
                        {% else %}
                            <span class="text-gray-500">Unknown</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-sm font-medium text-gray-500">Created At</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if scoring_system.created_at %}
                            {{ scoring_system.created_at|date:"F j, Y, g:i a" }}
                        {% else %}
                            <span class="text-gray-500">Unknown</span>
                        {% endif %}
                    </dd>
                </div>
            </dl>
        </div>
    </div>

    <!-- Score Rules Summary -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-5 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Score Rules</h3>
        </div>
        <div class="p-5">
            {% if score_rules %}
                <p class="text-sm text-gray-600 mb-4">This scoring system has {{ score_rules.count }} rules defined.</p>
                <a href="#score-rules" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-list mr-2"></i> View All Rules
                </a>
            {% else %}
                <div class="text-center py-4">
                    <p class="text-sm text-gray-600 mb-4">No scoring rules defined yet.</p>
                    <button id="addRuleBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-plus mr-2"></i> Add First Rule
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Score Ranges Summary -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-5 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Score Ranges</h3>
        </div>
        <div class="p-5">
            {% if score_ranges %}
                <p class="text-sm text-gray-600 mb-4">This scoring system has {{ score_ranges.count }} ranges defined.</p>
                <a href="#score-ranges" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-list mr-2"></i> View All Ranges
                </a>
            {% else %}
                <div class="text-center py-4">
                    <p class="text-sm text-gray-600 mb-4">No score ranges defined yet.</p>
                    <button id="addRangeBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-plus mr-2"></i> Add First Range
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Score Rules Section -->
<div id="score-rules" class="bg-white rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">Score Rules</h3>
        <button id="addRuleBtn" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <i class="fas fa-plus mr-1"></i> Add Rule
        </button>
    </div>
    <div class="p-5">
        {% if score_rules %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Question</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for rule in score_rules %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900">{{ rule.question.text|truncatechars:50 }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                        {{ rule.question.get_question_type_display }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ rule.weight }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button class="text-primary-600 hover:text-primary-900 mr-3 view-rule-btn" data-rule-id="{{ rule.id }}">View</button>
                                    <button class="text-red-600 hover:text-red-900 delete-rule-btn" data-rule-id="{{ rule.id }}">Delete</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-8">
                <p class="text-gray-500 mb-4">No scoring rules defined yet.</p>
                <button id="addFirstRuleBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-plus mr-2"></i> Add First Rule
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Score Ranges Section -->
<div id="score-ranges" class="bg-white rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-900">Score Ranges</h3>
        <button id="addRangeBtn" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
            <i class="fas fa-plus mr-1"></i> Add Range
        </button>
    </div>
    <div class="p-5">
        {% if score_ranges %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min Score</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Score</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Color</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for range in score_ranges %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900">{{ range.name }}</div>
                                    <div class="text-xs text-gray-500">{{ range.description|truncatechars:50 }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ range.min_score }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ range.max_score }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-block w-6 h-6 rounded-full" style="background-color: {{ range.color }};"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button class="text-primary-600 hover:text-primary-900 mr-3 view-range-btn" data-range-id="{{ range.id }}">View</button>
                                    <button class="text-red-600 hover:text-red-900 delete-range-btn" data-range-id="{{ range.id }}">Delete</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-8">
                <p class="text-gray-500 mb-4">No score ranges defined yet.</p>
                <button id="addFirstRangeBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-plus mr-2"></i> Add First Range
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Score Visualization Section -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Score Visualization</h3>
    </div>
    <div class="p-5">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Score Distribution Chart -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h4 class="text-md font-semibold text-gray-800 mb-4">Score Distribution</h4>
                <div class="h-64">
                    <canvas id="scoreDistributionChart"></canvas>
                </div>
            </div>

            <!-- Score Trends Chart -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h4 class="text-md font-semibold text-gray-800 mb-4">Score Trends Over Time</h4>
                <div class="h-64">
                    <canvas id="scoreTrendsChart"></canvas>
                </div>
            </div>

            <!-- Score by Demographics -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h4 class="text-md font-semibold text-gray-800 mb-4">Scores by Age Group</h4>
                <div class="h-64">
                    <canvas id="scoresByAgeChart"></canvas>
                </div>
            </div>

            <!-- Score Range Distribution -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                <h4 class="text-md font-semibold text-gray-800 mb-4">Score Range Distribution</h4>
                <div class="h-64">
                    <canvas id="scoreRangeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Scores Section -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="p-5 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Recent Scores</h3>
    </div>
    <div class="p-5">
        {% if response_scores %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Response</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Range</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Z-Score</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentile</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calculated At</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for score in response_scores %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {% if score.response.patient_email %}
                                            {{ score.response.patient_email }}
                                        {% else %}
                                            Anonymous
                                        {% endif %}
                                    </div>
                                    <div class="text-xs text-gray-500">ID: {{ score.response.id }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                                    {{ score.raw_score }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if score.score_range %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color: {{ score.score_range.color }}; color: #fff;">
                                            {{ score.score_range.name }}
                                        </span>
                                    {% else %}
                                        <span class="text-gray-500">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {% if score.z_score != None %}
                                        {{ score.z_score|floatformat:2 }}
                                    {% else %}
                                        <span class="text-gray-500">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {% if score.percentile != None %}
                                        {{ score.percentile|floatformat:1 }}%
                                    {% else %}
                                        <span class="text-gray-500">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ score.calculated_at|date:"M d, Y H:i" }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="{% url 'feedback:response_detail' pk=score.response.id %}" class="text-primary-600 hover:text-primary-900">View Response</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-8">
                <p class="text-gray-500 mb-4">No scores calculated yet.</p>
                <button id="calculateFirstScoreBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                    <i class="fas fa-calculator mr-2"></i> Calculate First Score
                </button>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Toast notification function
    function showToast(message, type = 'info') {
        // Check if toast container exists, if not create it
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'fixed bottom-4 right-4 z-50';
            document.body.appendChild(toastContainer);
        }

        // Create toast element
        const toast = document.createElement('div');
        toast.className = `mb-3 p-4 rounded-lg shadow-lg flex items-center transition-all transform translate-y-0 opacity-100 max-w-xs`;

        // Set background color based on type
        if (type === 'success') {
            toast.classList.add('bg-green-500', 'text-white');
        } else if (type === 'error') {
            toast.classList.add('bg-red-500', 'text-white');
        } else if (type === 'warning') {
            toast.classList.add('bg-yellow-500', 'text-white');
        } else {
            toast.classList.add('bg-blue-500', 'text-white');
        }

        // Add message
        toast.innerHTML = `
            <div class="flex-1">${message}</div>
            <button class="ml-2 text-white focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        `;

        // Add to container
        toastContainer.appendChild(toast);

        // Add click event to close button
        toast.querySelector('button').addEventListener('click', () => {
            toast.classList.add('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.remove();
            }, 300);
        });

        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Add Rule Button
        const addRuleBtn = document.getElementById('addRuleBtn');
        if (addRuleBtn) {
            addRuleBtn.addEventListener('click', function() {
                // Implement add rule functionality
                alert('Add rule functionality will be implemented here');
            });
        }

        // Add Range Button
        const addRangeBtn = document.getElementById('addRangeBtn');
        if (addRangeBtn) {
            addRangeBtn.addEventListener('click', function() {
                // Implement add range functionality
                alert('Add range functionality will be implemented here');
            });
        }

        // Calculate All Scores Button
        const calculateAllScoresBtn = document.getElementById('calculateAllScoresBtn');
        if (calculateAllScoresBtn) {
            calculateAllScoresBtn.addEventListener('click', function() {
                const systemId = this.getAttribute('data-system-id');
                calculateAllScores(systemId);
            });
        }

        // Export Dropdown
        const exportDropdownButton = document.getElementById('exportDropdownButton');
        const exportDropdown = document.getElementById('exportDropdown');

        if (exportDropdownButton && exportDropdown) {
            exportDropdownButton.addEventListener('click', function() {
                exportDropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!exportDropdownButton.contains(event.target) && !exportDropdown.contains(event.target)) {
                    exportDropdown.classList.add('hidden');
                }
            });
        }

        // View Rule Buttons
        const viewRuleBtns = document.querySelectorAll('.view-rule-btn');
        viewRuleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const ruleId = this.getAttribute('data-rule-id');
                // Implement view rule functionality
                alert(`View rule ${ruleId} functionality will be implemented here`);
            });
        });

        // Delete Rule Buttons
        const deleteRuleBtns = document.querySelectorAll('.delete-rule-btn');
        deleteRuleBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const ruleId = this.getAttribute('data-rule-id');
                // Implement delete rule functionality
                if (confirm('Are you sure you want to delete this rule?')) {
                    alert(`Delete rule ${ruleId} functionality will be implemented here`);
                }
            });
        });

        // View Range Buttons
        const viewRangeBtns = document.querySelectorAll('.view-range-btn');
        viewRangeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const rangeId = this.getAttribute('data-range-id');
                // Implement view range functionality
                alert(`View range ${rangeId} functionality will be implemented here`);
            });
        });

        // Delete Range Buttons
        const deleteRangeBtns = document.querySelectorAll('.delete-range-btn');
        deleteRangeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const rangeId = this.getAttribute('data-range-id');
                // Implement delete range functionality
                if (confirm('Are you sure you want to delete this range?')) {
                    alert(`Delete range ${rangeId} functionality will be implemented here`);
                }
            });
        });

        // Initialize charts
        initializeCharts();
    });

    function calculateAllScores(systemId) {
        // Check if systemId is valid
        if (!systemId) {
            showToast('Error: Invalid scoring system ID', 'error');
            return;
        }

        // Show confirmation dialog
        if (!confirm('Calculate scores for all responses? This may take a while for questionnaires with many responses.')) {
            return;
        }

        // Show loading indicator
        showToast('Calculating all scores...', 'info');

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Make API request
        fetch(`/dashboard/api/scoring/systems/${systemId}/calculate-all/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Calculated ${data.successful} scores successfully!`, 'success');
                // Refresh the page to show updated scores
                window.location.reload();
            } else {
                showToast('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error calculating scores: ' + error, 'error');
        });
    }

    function initializeCharts() {
        // Get scoring system ID
        const calculateBtn = document.getElementById('calculateAllScoresBtn');
        if (!calculateBtn) return;

        const systemId = calculateBtn.getAttribute('data-system-id');
        if (!systemId) return;

        // Fetch data for charts
        fetch(`/dashboard/api/scoring/systems/${systemId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.scoring_system) {
                    const scoringSystem = data.scoring_system;

                    // Create score distribution chart
                    createScoreDistributionChart(scoringSystem);

                    // Create score trends chart
                    createScoreTrendsChart(scoringSystem);

                    // Create scores by age chart
                    createScoresByAgeChart(scoringSystem);

                    // Create score range chart
                    createScoreRangeChart(scoringSystem);
                }
            })
            .catch(error => {
                console.error('Error fetching scoring system data:', error);
            });
    }

    function createScoreDistributionChart(scoringSystem) {
        const ctx = document.getElementById('scoreDistributionChart').getContext('2d');

        // Process scores into bins for histogram
        const scores = scoringSystem.recent_scores.map(score => score.raw_score);

        // Calculate min and max scores
        const minScore = Math.min(...scores);
        const maxScore = Math.max(...scores);

        // Create bins (10 bins between min and max)
        const binCount = 10;
        const binSize = (maxScore - minScore) / binCount;
        const bins = Array(binCount).fill(0);

        // Count scores in each bin
        scores.forEach(score => {
            const binIndex = Math.min(Math.floor((score - minScore) / binSize), binCount - 1);
            bins[binIndex]++;
        });

        // Create labels for bins
        const labels = [];
        for (let i = 0; i < binCount; i++) {
            const start = minScore + (i * binSize);
            const end = minScore + ((i + 1) * binSize);
            labels.push(`${start.toFixed(1)}-${end.toFixed(1)}`);
        }

        // Create chart
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Score Distribution',
                    data: bins,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Responses'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Score Range'
                        }
                    }
                }
            }
        });
    }

    function createScoreTrendsChart(scoringSystem) {
        const ctx = document.getElementById('scoreTrendsChart').getContext('2d');

        // Process scores by date
        const scores = scoringSystem.recent_scores;

        // Sort scores by date
        scores.sort((a, b) => new Date(a.calculated_at) - new Date(b.calculated_at));

        // Group scores by date (YYYY-MM-DD)
        const scoresByDate = {};
        scores.forEach(score => {
            const date = score.calculated_at.split('T')[0];
            if (!scoresByDate[date]) {
                scoresByDate[date] = [];
            }
            scoresByDate[date].push(score.raw_score);
        });

        // Calculate average score for each date
        const dates = Object.keys(scoresByDate);
        const averageScores = dates.map(date => {
            const scores = scoresByDate[date];
            return scores.reduce((sum, score) => sum + score, 0) / scores.length;
        });

        // Create chart
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Average Score',
                    data: averageScores,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Average Score'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
    }

    function createScoresByAgeChart(scoringSystem) {
        const ctx = document.getElementById('scoresByAgeChart').getContext('2d');

        // Process scores by age group
        const scores = scoringSystem.recent_scores;

        // Define age groups
        const ageGroups = {
            '0-18': { scores: [], color: 'rgba(255, 99, 132, 0.5)' },
            '19-30': { scores: [], color: 'rgba(54, 162, 235, 0.5)' },
            '31-45': { scores: [], color: 'rgba(255, 206, 86, 0.5)' },
            '46-60': { scores: [], color: 'rgba(75, 192, 192, 0.5)' },
            '61+': { scores: [], color: 'rgba(153, 102, 255, 0.5)' }
        };

        // Group scores by age
        scores.forEach(score => {
            const age = score.response_age || 0;

            let ageGroup;
            if (age <= 18) ageGroup = '0-18';
            else if (age <= 30) ageGroup = '19-30';
            else if (age <= 45) ageGroup = '31-45';
            else if (age <= 60) ageGroup = '46-60';
            else ageGroup = '61+';

            ageGroups[ageGroup].scores.push(score.raw_score);
        });

        // Calculate average score for each age group
        const labels = Object.keys(ageGroups);
        const data = labels.map(label => {
            const scores = ageGroups[label].scores;
            return scores.length > 0 ? scores.reduce((sum, score) => sum + score, 0) / scores.length : 0;
        });

        // Get colors
        const backgroundColor = labels.map(label => ageGroups[label].color);
        const borderColor = backgroundColor.map(color => color.replace('0.5', '1'));

        // Create chart
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Score by Age Group',
                    data: data,
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Average Score'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Age Group'
                        }
                    }
                }
            }
        });
    }

    function createScoreRangeChart(scoringSystem) {
        const ctx = document.getElementById('scoreRangeChart').getContext('2d');

        // Process scores by range
        const scores = scoringSystem.recent_scores;
        const ranges = scoringSystem.ranges;

        // Count scores in each range
        const rangeData = {};
        ranges.forEach(range => {
            rangeData[range.id] = {
                name: range.name,
                color: range.color,
                count: 0
            };
        });

        // Count scores without a range
        let noRangeCount = 0;

        // Count scores in each range
        scores.forEach(score => {
            if (score.score_range) {
                rangeData[score.score_range.id].count++;
            } else {
                noRangeCount++;
            }
        });

        // Prepare data for chart
        const labels = Object.values(rangeData).map(range => range.name);
        if (noRangeCount > 0) {
            labels.push('No Range');
        }

        const data = Object.values(rangeData).map(range => range.count);
        if (noRangeCount > 0) {
            data.push(noRangeCount);
        }

        const backgroundColor = Object.values(rangeData).map(range => range.color + '80');
        if (noRangeCount > 0) {
            backgroundColor.push('rgba(200, 200, 200, 0.5)');
        }

        // Create chart
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColor,
                    borderColor: backgroundColor.map(color => color.replace('0.5', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Score Range Distribution'
                    }
                }
            }
        });
    }

    function showToast(message, type = 'info') {
        // Check if toast container exists
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            // Create toast container
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'fixed bottom-4 right-4 z-50';
            document.body.appendChild(toastContainer);
        }

        // Create toast
        const toast = document.createElement('div');
        toast.className = 'mb-3 p-4 rounded-md shadow-lg transform transition-all duration-300 ease-in-out opacity-0 translate-y-2';

        // Set toast color based on type
        if (type === 'success') {
            toast.className += ' bg-green-500 text-white';
        } else if (type === 'error') {
            toast.className += ' bg-red-500 text-white';
        } else {
            toast.className += ' bg-blue-500 text-white';
        }

        // Set toast content
        toast.innerHTML = message;

        // Add toast to container
        toastContainer.appendChild(toast);

        // Animate toast in
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');
        }, 10);

        // Remove toast after 3 seconds
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-2');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}
