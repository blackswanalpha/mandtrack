{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ questionnaire.title }} - MindTrack{% endblock %}

{% block content %}
<div class="bg-white py-8">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-display font-bold text-gray-900">{{ questionnaire.title }}</h1>
            {% if questionnaire.description %}
                <p class="mt-4 text-gray-600">{{ questionnaire.description }}</p>
            {% endif %}
        </div>

        {% if questionnaire.instructions %}
            <div class="bg-blue-50 rounded-lg p-4 mb-8 transform transition-all duration-500 hover:scale-[1.01] hover:shadow-md">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Instructions</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            {{ questionnaire.instructions|linebreaks }}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <form method="post" class="space-y-8" id="questionnaireForm">
            {% csrf_token %}

            <!-- Respondent Information -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg transform transition-all duration-500 hover:shadow-md">
                <div class="px-4 py-5 sm:px-6">
                    <h2 class="text-lg font-medium text-gray-900">Your Information</h2>
                    <p class="mt-1 text-sm text-gray-500">Please provide your contact details.</p>
                </div>
                <div class="border-t border-gray-200 px-4 py-5 sm:p-6">
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                        <div class="sm:col-span-6">
                            <label for="patient_email" class="block text-sm font-medium text-gray-700">Email <span class="text-red-500">*</span></label>
                            <div class="mt-1">
                                <input type="email" name="patient_email" id="patient_email" required
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300">
                            </div>
                        </div>
                        <div class="sm:col-span-3">
                            <label for="patient_age" class="block text-sm font-medium text-gray-700">Age <span class="text-red-500">*</span></label>
                            <div class="mt-1">
                                <input type="number" name="patient_age" id="patient_age" min="1" max="120" required
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300">
                            </div>
                        </div>
                        <div class="sm:col-span-3">
                            <label for="patient_gender" class="block text-sm font-medium text-gray-700">Gender <span class="text-red-500">*</span></label>
                            <div class="mt-1">
                                <select name="patient_gender" id="patient_gender" required
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300">
                                    <option value="">Select gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="non-binary">Non-Binary</option>
                                    <option value="prefer_not_to_say">Prefer Not to Say</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-8">
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-primary-600 bg-primary-200 shadow-sm">
                                <i class="fas fa-chart-line mr-1"></i> Progress
                            </span>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-semibold inline-block text-primary-600 bg-white py-1 px-2 rounded-full shadow-sm" id="progress-text">
                                Question <span id="current-question-num">1</span> of {{ questions|length }}
                            </span>
                        </div>
                    </div>
                    <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-primary-100 shadow-inner">
                        <div id="progress-bar" style="width: 0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-primary-500 to-primary-600 transition-all duration-500 rounded-full"></div>
                    </div>
                </div>
            </div>

            <!-- Questions -->
            <div id="questions-container">
                {% for question in questions %}
                    <div class="bg-white shadow overflow-hidden sm:rounded-lg question-container transform transition-all duration-500 hover:shadow-md"
                         id="question-{{ question.id }}"
                         data-question-index="{{ forloop.counter0 }}"
                         style="display: {% if forloop.first %}block{% else %}none{% endif %};"
                         x-data="{ focused: false }"
                         x-on:focusin="focused = true"
                         x-on:focusout="focused = false"
                         :class="{ 'ring-2 ring-primary-500 ring-opacity-50': focused }">
                        <div class="px-4 py-5 sm:px-6">
                            <div class="flex items-center">
                                <span class="w-6 h-6 flex items-center justify-center rounded-full bg-primary-100 text-primary-600 text-xs mr-2">
                                    {{ forloop.counter }}
                                </span>
                                <h2 class="text-lg font-medium text-gray-900">{{ question.text }}</h2>
                                {% if question.required %}
                                    <span class="ml-2 px-1.5 py-0.5 text-xs rounded-full bg-red-100 text-red-800">Required</span>
                                {% endif %}
                            </div>
                            {% if question.description %}
                                <p class="mt-1 ml-8 text-sm text-gray-500">{{ question.description }}</p>
                            {% endif %}
                        </div>
                        <div class="border-t border-gray-200 px-4 py-5 sm:p-6">
                            {% if question.question_type == 'text' %}
                                <input type="text" name="question_{{ question.id }}" id="question_{{ question.id }}"
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300"
                                       {% if question.required %}required{% endif %}>

                            {% elif question.question_type == 'textarea' %}
                                <textarea name="question_{{ question.id }}" id="question_{{ question.id }}" rows="4"
                                          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300"
                                          {% if question.required %}required{% endif %}></textarea>

                            {% elif question.question_type == 'number' %}
                                <input type="number" name="question_{{ question.id }}" id="question_{{ question.id }}"
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300"
                                       {% if question.required %}required{% endif %}>

                            {% elif question.question_type == 'single_choice' %}
                                <fieldset>
                                    <legend class="sr-only">{{ question.text }}</legend>
                                    <div class="space-y-3">
                                        {% for choice in question.choices.all %}
                                            <div class="flex items-center transform transition-all duration-300 hover:translate-x-1">
                                                <input id="choice_{{ choice.id }}" name="question_{{ question.id }}" type="radio" value="{{ choice.id }}"
                                                       class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300"
                                                       {% if question.required %}required{% endif %}>
                                                <label for="choice_{{ choice.id }}" class="ml-3 block text-sm font-medium text-gray-700">
                                                    {{ choice.text }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </fieldset>

                            {% elif question.question_type == 'multiple_choice' %}
                                <fieldset>
                                    <legend class="sr-only">{{ question.text }}</legend>
                                    <div class="space-y-3">
                                        {% for choice in question.choices.all %}
                                            <div class="flex items-center transform transition-all duration-300 hover:translate-x-1">
                                                <input id="choice_{{ choice.id }}" name="question_{{ question.id }}" type="checkbox" value="{{ choice.id }}"
                                                       class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded">
                                                <label for="choice_{{ choice.id }}" class="ml-3 block text-sm font-medium text-gray-700">
                                                    {{ choice.text }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </fieldset>

                            {% elif question.question_type == 'scale' %}
                                <div class="mt-2">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm text-gray-500">0</span>
                                        <span class="text-sm text-gray-500">10</span>
                                    </div>
                                    <input type="range" name="question_{{ question.id }}" id="question_{{ question.id }}" min="0" max="10" step="1" value="5"
                                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                           {% if question.required %}required{% endif %}
                                           oninput="document.getElementById('scale_value_{{ question.id }}').textContent = this.value">
                                    <div class="mt-2 text-center">
                                        <span class="text-sm font-medium text-gray-700" id="scale_value_{{ question.id }}">5</span>
                                    </div>
                                </div>

                            {% elif question.question_type == 'date' %}
                                <input type="date" name="question_{{ question.id }}" id="question_{{ question.id }}"
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300"
                                       {% if question.required %}required{% endif %}>

                            {% elif question.question_type == 'time' %}
                                <input type="time" name="question_{{ question.id }}" id="question_{{ question.id }}"
                                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 transition-all duration-300"
                                       {% if question.required %}required{% endif %}>

                            {% elif question.question_type == 'file' %}
                                <input type="file" name="question_{{ question.id }}" id="question_{{ question.id }}"
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 transition-all duration-300"
                                       {% if question.required %}required{% endif %}>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between mt-8">
                <button type="button" id="prev-button" class="inline-flex items-center px-5 py-2.5 border border-gray-300 shadow-sm text-sm font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-300" style="display: none;">
                    <i class="fas fa-arrow-left mr-2"></i> Previous
                </button>
                <div class="flex-grow"></div>
                <button type="button" id="next-button" class="inline-flex items-center px-5 py-2.5 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-300">
                    Next <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button type="submit" id="submit-button" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-300 transform hover:scale-105" style="display: none;">
                    <i class="fas fa-check-circle mr-2"></i> Submit Response
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Wait for the DOM to be fully loaded
    window.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing questionnaire...');

        // Initialize variables
        const questions = document.querySelectorAll('.question-container');
        const totalQuestions = questions.length;
        const progressBar = document.getElementById('progress-bar');
        const currentQuestionNum = document.getElementById('current-question-num');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const submitButton = document.getElementById('submit-button');
        const form = document.getElementById('questionnaireForm');
        let currentQuestionIndex = 0;

        console.log(`Found ${totalQuestions} questions`);

        // Make sure all questions except the first are hidden
        questions.forEach((question, index) => {
            if (index === 0) {
                question.style.display = 'block';
                question.classList.add('translate-y-0', 'opacity-100');
            } else {
                question.style.display = 'none';
            }
        });

        // Initialize the progress bar
        updateProgressBar();

        // Make sure the first question is visible and animated
        if (questions.length > 0) {
            questions[0].style.display = 'block';
            setTimeout(() => {
                questions[0].classList.add('translate-y-0', 'opacity-100');
            }, 100);
        }

        // Handle next button click
        if (nextButton) {
            nextButton.addEventListener('click', function() {
                console.log(`Next button clicked, current index: ${currentQuestionIndex}`);

                // Validate current question if required
                const currentQuestion = questions[currentQuestionIndex];
                const inputs = currentQuestion.querySelectorAll('input, textarea, select');
                let isValid = true;

                inputs.forEach(input => {
                    const dataRequired = input.getAttribute('data-required') === 'true';
                    if ((input.required || dataRequired) && !input.value) {
                        isValid = false;
                        input.classList.add('border-red-500');
                        input.classList.add('animate-shake');
                        setTimeout(() => {
                            input.classList.remove('animate-shake');
                        }, 500);
                    } else {
                        input.classList.remove('border-red-500');
                    }
                });

                if (!isValid) {
                    console.log('Validation failed');
                    return;
                }

                // Move to next question
                if (currentQuestionIndex < totalQuestions - 1) {
                    questions[currentQuestionIndex].style.display = 'none';
                    currentQuestionIndex++;
                    questions[currentQuestionIndex].style.display = 'block';

                    // Animate the new question
                    setTimeout(() => {
                        questions[currentQuestionIndex].classList.add('translate-y-0', 'opacity-100');
                    }, 50);

                    // Update progress
                    updateProgressBar();

                    // Show/hide navigation buttons
                    prevButton.style.display = 'inline-flex';

                    if (currentQuestionIndex === totalQuestions - 1) {
                        nextButton.style.display = 'none';
                        submitButton.style.display = 'inline-flex';
                    }

                    console.log(`Moved to question ${currentQuestionIndex + 1}`);
                }
            });
        }

        // Handle previous button click
        if (prevButton) {
            prevButton.addEventListener('click', function() {
                console.log(`Previous button clicked, current index: ${currentQuestionIndex}`);

                if (currentQuestionIndex > 0) {
                    questions[currentQuestionIndex].style.display = 'none';
                    currentQuestionIndex--;
                    questions[currentQuestionIndex].style.display = 'block';

                    // Update progress
                    updateProgressBar();

                    // Show/hide navigation buttons
                    if (currentQuestionIndex === 0) {
                        prevButton.style.display = 'none';
                    }

                    nextButton.style.display = 'inline-flex';
                    submitButton.style.display = 'none';

                    console.log(`Moved back to question ${currentQuestionIndex + 1}`);
                }
            });
        }

        // Update progress bar
        function updateProgressBar() {
            if (!progressBar || !currentQuestionNum) return;

            const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            progressBar.style.width = `${progress}%`;
            currentQuestionNum.textContent = currentQuestionIndex + 1;
            console.log(`Progress updated to ${progress}%`);
        }

        // Form submission
        if (form) {
            form.addEventListener('submit', function(event) {
                console.log('Form submitted');

                // Validate email field
                const emailField = document.getElementById('patient_email');
                if (emailField && emailField.value.trim() === '') {
                    event.preventDefault();
                    emailField.classList.add('border-red-500');
                    emailField.classList.add('animate-shake');
                    setTimeout(() => {
                        emailField.classList.remove('animate-shake');
                    }, 500);

                    // Scroll to the email field
                    emailField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false;
                }

                // Re-enable required attributes for final validation
                document.querySelectorAll('[data-required="true"]').forEach(el => {
                    el.setAttribute('required', 'required');
                });

                // Make sure age is a number or empty
                const ageField = document.getElementById('patient_age');
                if (ageField && ageField.value.trim() !== '') {
                    const ageValue = parseInt(ageField.value);
                    if (isNaN(ageValue)) {
                        event.preventDefault();
                        ageField.classList.add('border-red-500');
                        ageField.classList.add('animate-shake');
                        setTimeout(() => {
                            ageField.classList.remove('animate-shake');
                        }, 500);
                        return false;
                    }
                }
            });
        }

        // Disable HTML5 validation for individual questions
        // We'll handle validation manually when navigating between questions
        document.querySelectorAll('[required]').forEach(el => {
            el.setAttribute('data-required', 'true');
            el.removeAttribute('required');
        });

        console.log('Questionnaire initialization complete');
    });
</script>

<style>
    .question-container {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease-out;
        margin-bottom: 1rem;
    }

    .question-container.translate-y-0 {
        opacity: 1;
        transform: translateY(0);
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
    }

    .animate-shake {
        animation: shake 0.5s ease-in-out;
    }

    /* Progress bar animation */
    #progress-bar {
        transition: width 0.5s ease-in-out;
    }

    /* Button animations */
    button {
        transition: all 0.3s ease-in-out;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Input focus styles */
    input:focus, textarea:focus, select:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }

    /* Error state */
    .border-red-500 {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
    }
</style>
{% endblock %}
