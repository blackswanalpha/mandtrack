{% extends 'admin_portal/modern_base.html' %}

{% block title %}{% if is_edit %}Edit Question{% else %}Add Question{% endif %} - MindTrack{% endblock %}

{% block content %}
<div class="bg-white py-8">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <div class="flex items-center">
                <a href="{% url 'surveys:survey_detail' pk=questionnaire.pk %}" class="text-primary-600 hover:text-primary-900 mr-2">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-3xl font-display font-bold text-gray-900">
                    {% if is_edit %}Edit Question{% else %}Add Question{% endif %}
                </h1>
            </div>
            <p class="mt-2 text-gray-600">
                {% if is_edit %}
                    Update question for "{{ questionnaire.title }}"
                {% else %}
                    Add a new question to "{{ questionnaire.title }}"
                {% endif %}
            </p>
        </div>

        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <form method="post" class="space-y-6" id="questionForm">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                        <div class="rounded-md bg-red-50 p-4 mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle text-red-400"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">There were errors with your submission</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        <ul class="list-disc pl-5 space-y-1">
                                            {% for error in form.non_field_errors %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Question Text -->
                    <div>
                        <label for="{{ form.text.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            Question Text <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1">
                            <textarea name="{{ form.text.name }}" id="{{ form.text.id_for_label }}" rows="2"
                                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 {% if form.text.errors %}border-red-300{% endif %}"
                                      required>{{ form.text.value|default:'' }}</textarea>
                        </div>
                        {% if form.text.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.text.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            Description
                        </label>
                        <div class="mt-1">
                            <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" rows="2"
                                      class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 {% if form.description.errors %}border-red-300{% endif %}">{{ form.description.value|default:'' }}</textarea>
                        </div>
                        {% if form.description.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                        {% endif %}
                        <p class="mt-1 text-sm text-gray-500">Additional information or instructions for this question (optional)</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Question Type -->
                        <div>
                            <label for="{{ form.question_type.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                Question Type <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                <select name="{{ form.question_type.name }}" id="{{ form.question_type.id_for_label }}"
                                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 {% if form.question_type.errors %}border-red-300{% endif %}"
                                        onchange="toggleQuestionTypeInfo(); toggleChoicesSection()">
                                    {% for value, label in form.fields.question_type.choices %}
                                        <option value="{{ value }}" {% if form.question_type.value == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% if form.question_type.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.question_type.errors.0 }}</p>
                            {% endif %}

                            <!-- Question Type Info Box -->
                            <div id="questionTypeInfo" class="mt-3 p-3 bg-gray-50 rounded-md border border-gray-200">
                                <div id="type-text" class="question-type-info">
                                    <h4 class="text-sm font-medium text-gray-700">Text</h4>
                                    <p class="text-xs text-gray-500">A single-line text input for short answers.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-check-circle mr-1"></i> Simple
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fas fa-keyboard mr-1"></i> Text input
                                        </span>
                                    </div>
                                </div>
                                <div id="type-textarea" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">Long Text</h4>
                                    <p class="text-xs text-gray-500">A multi-line text area for longer responses.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-paragraph mr-1"></i> Detailed
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fas fa-align-left mr-1"></i> Multi-line
                                        </span>
                                    </div>
                                </div>
                                <div id="type-number" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">Number</h4>
                                    <p class="text-xs text-gray-500">A numeric input field for collecting numbers.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-calculator mr-1"></i> Numeric
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fas fa-chart-line mr-1"></i> Analyzable
                                        </span>
                                    </div>
                                </div>
                                <div id="type-single_choice" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">Single Choice</h4>
                                    <p class="text-xs text-gray-500">Radio buttons allowing selection of one option from multiple choices.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-dot-circle mr-1"></i> One selection
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fas fa-chart-pie mr-1"></i> Easy to analyze
                                        </span>
                                    </div>
                                </div>
                                <div id="type-multiple_choice" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">Multiple Choice</h4>
                                    <p class="text-xs text-gray-500">Checkboxes allowing selection of multiple options from choices.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-check-square mr-1"></i> Multiple selections
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fas fa-chart-bar mr-1"></i> Comprehensive data
                                        </span>
                                    </div>
                                </div>
                                <div id="type-scale" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">Scale</h4>
                                    <p class="text-xs text-gray-500">A linear scale (e.g., 1-5, 1-10) for rating questions.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-sliders-h mr-1"></i> Rating
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fas fa-chart-line mr-1"></i> Quantifiable
                                        </span>
                                    </div>
                                </div>
                                <div id="type-date" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">Date</h4>
                                    <p class="text-xs text-gray-500">A date picker for collecting date information.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-calendar-alt mr-1"></i> Date format
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fas fa-sort mr-1"></i> Chronological
                                        </span>
                                    </div>
                                </div>
                                <div id="type-time" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">Time</h4>
                                    <p class="text-xs text-gray-500">A time picker for collecting time information.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-clock mr-1"></i> Time format
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fas fa-hourglass-half mr-1"></i> Duration data
                                        </span>
                                    </div>
                                </div>
                                <div id="type-file" class="question-type-info hidden">
                                    <h4 class="text-sm font-medium text-gray-700">File Upload</h4>
                                    <p class="text-xs text-gray-500">Allows respondents to upload files as part of their response.</p>
                                    <div class="mt-2 flex items-center text-xs text-gray-500">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 mr-2">
                                            <i class="fas fa-file-upload mr-1"></i> Document collection
                                        </span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                            <i class="fas fa-exclamation-triangle mr-1"></i> Storage required
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Required and Scoring Options -->
                        <div>
                            <div class="space-y-4">
                                <!-- Required Checkbox -->
                                <div>
                                    <div class="flex items-center">
                                        <input type="checkbox" name="{{ form.required.name }}" id="{{ form.required.id_for_label }}"
                                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                                               {% if form.required.value %}checked{% endif %}>
                                        <label for="{{ form.required.id_for_label }}" class="ml-2 block text-sm text-gray-700">
                                            Make this question required
                                        </label>
                                    </div>
                                    {% if form.required.errors %}
                                        <p class="mt-2 text-sm text-red-600">{{ form.required.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <!-- Is Scored Checkbox -->
                                <div>
                                    <div class="flex items-center">
                                        <input type="checkbox" name="{{ form.is_scored.name }}" id="{{ form.is_scored.id_for_label }}"
                                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                                               {% if form.is_scored.value %}checked{% endif %}
                                               onchange="toggleScoringFields(this.checked)">
                                        <label for="{{ form.is_scored.id_for_label }}" class="ml-2 block text-sm text-gray-700">
                                            Enable scoring for this question
                                        </label>
                                    </div>
                                    {% if form.is_scored.errors %}
                                        <p class="mt-2 text-sm text-red-600">{{ form.is_scored.errors.0 }}</p>
                                    {% endif %}
                                </div>

                                <!-- Scoring Fields (initially hidden if not scored) -->
                                <div id="scoringFields" class="{% if not form.is_scored.value %}hidden{% endif %} space-y-4 p-3 bg-gray-50 rounded-md border border-gray-200">
                                    <!-- Scoring Weight -->
                                    <div>
                                        <label for="{{ form.scoring_weight.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                            Scoring Weight
                                        </label>
                                        <div class="mt-1">
                                            <input type="number" name="{{ form.scoring_weight.name }}" id="{{ form.scoring_weight.id_for_label }}"
                                                   value="{{ form.scoring_weight.value|default:'1.0' }}" step="0.1" min="0"
                                                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">Weight applied to this question's score (default: 1.0)</p>
                                        {% if form.scoring_weight.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.scoring_weight.errors.0 }}</p>
                                        {% endif %}
                                    </div>

                                    <!-- Max Score -->
                                    <div>
                                        <label for="{{ form.max_score.id_for_label }}" class="block text-sm font-medium text-gray-700">
                                            Max Score
                                        </label>
                                        <div class="mt-1">
                                            <input type="number" name="{{ form.max_score.name }}" id="{{ form.max_score.id_for_label }}"
                                                   value="{{ form.max_score.value|default:'0' }}" step="0.1" min="0"
                                                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        </div>
                                        <p class="mt-1 text-xs text-gray-500">Maximum possible score for this question (default: 0)</p>
                                        {% if form.max_score.errors %}
                                            <p class="mt-2 text-sm text-red-600">{{ form.max_score.errors.0 }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order -->
                    <div class="hidden">
                        <input type="number" name="{{ form.order.name }}" id="{{ form.order.id_for_label }}"
                               value="{{ form.order.value|default:'0' }}">
                    </div>

                    <!-- Choices Section (for multiple choice questions) -->
                    <div id="choicesSection" class="{% if form.question_type.value not in 'single_choice,multiple_choice' %}hidden{% endif %} border-t border-gray-200 pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Answer Choices</h3>
                        <div class="flex items-center mb-4">
                            <p class="text-sm text-gray-500">Add options for this question</p>
                            <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800">Required</span>
                        </div>
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        For choice-based questions, you must add at least one choice. If you don't add any choices, default options will be created.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div id="choicesContainer" class="space-y-3">
                            {% if is_edit and choices %}
                                {% for choice in choices %}
                                    <div class="choice-item grid grid-cols-12 gap-2">
                                        <div class="col-span-1 flex items-center justify-center">
                                            <span class="choice-number w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 text-xs">
                                                {{ forloop.counter }}
                                            </span>
                                        </div>
                                        <div class="col-span-8">
                                            <input type="text" name="choice_text" value="{{ choice.text }}" placeholder="Choice text"
                                                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        </div>
                                        <div class="col-span-2">
                                            <input type="number" name="choice_score" value="{{ choice.score }}" placeholder="Score"
                                                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        </div>
                                        <div class="col-span-1 flex items-center justify-center">
                                            <button type="button" class="text-red-500 hover:text-red-700" onclick="removeChoice(this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="choice-item grid grid-cols-12 gap-2">
                                    <div class="col-span-1 flex items-center justify-center">
                                        <span class="choice-number w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 text-xs">1</span>
                                    </div>
                                    <div class="col-span-8">
                                        <input type="text" name="choice_text" placeholder="Choice text"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                    </div>
                                    <div class="col-span-2">
                                        <input type="number" name="choice_score" placeholder="Score" value="0"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                    </div>
                                    <div class="col-span-1 flex items-center justify-center">
                                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeChoice(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="choice-item grid grid-cols-12 gap-2">
                                    <div class="col-span-1 flex items-center justify-center">
                                        <span class="choice-number w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 text-xs">2</span>
                                    </div>
                                    <div class="col-span-8">
                                        <input type="text" name="choice_text" placeholder="Choice text"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                    </div>
                                    <div class="col-span-2">
                                        <input type="number" name="choice_score" placeholder="Score" value="0"
                                               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                    </div>
                                    <div class="col-span-1 flex items-center justify-center">
                                        <button type="button" class="text-red-500 hover:text-red-700" onclick="removeChoice(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <button type="button" onclick="addChoice()" class="mt-3 inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            <i class="fas fa-plus mr-1.5"></i> Add Choice
                        </button>
                    </div>

                    <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                        <a href="{% url 'surveys:survey_detail' pk=questionnaire.pk %}"
                           class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            Cancel
                        </a>
                        <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            {% if is_edit %}Save Changes{% else %}Add Question{% endif %}
                        </button>
                    </div>
                </form>

                {% include 'surveys/debug_panel.html' %}
            </div>
        </div>
    </div>
</div>

<script>
    function toggleQuestionTypeInfo() {
        const questionType = document.getElementById('{{ form.question_type.id_for_label }}').value;
        console.log('Question type changed to:', questionType);

        // Hide all question type info divs
        document.querySelectorAll('.question-type-info').forEach(div => {
            div.classList.add('hidden');
        });

        // Show the selected question type info
        const selectedTypeInfo = document.getElementById(`type-${questionType}`);
        if (selectedTypeInfo) {
            selectedTypeInfo.classList.remove('hidden');
        } else {
            console.warn(`No info div found for question type: ${questionType}`);
        }

        // Also toggle the choices section when question type changes
        toggleChoicesSection(questionType);
    }

    function toggleChoicesSection(questionType) {
        // If questionType is not provided, get it from the select element
        if (!questionType) {
            questionType = document.getElementById('{{ form.question_type.id_for_label }}').value;
        }

        console.log('Toggling choices section for question type:', questionType);

        const choicesSection = document.getElementById('choicesSection');

        if (['single_choice', 'multiple_choice'].includes(questionType)) {
            console.log('Showing choices section');
            choicesSection.classList.remove('hidden');

            // Ensure we have at least two choices
            const choiceItems = document.querySelectorAll('.choice-item');
            if (choiceItems.length < 2) {
                // Add choices until we have at least 2
                while (document.querySelectorAll('.choice-item').length < 2) {
                    addChoice();
                }
            }
        } else {
            console.log('Hiding choices section');
            choicesSection.classList.add('hidden');
        }
    }

    function addChoice() {
        const container = document.getElementById('choicesContainer');
        const choiceItems = container.querySelectorAll('.choice-item');
        const newIndex = choiceItems.length + 1;

        const newChoice = document.createElement('div');
        newChoice.className = 'choice-item grid grid-cols-12 gap-2';
        newChoice.innerHTML = `
            <div class="col-span-1 flex items-center justify-center">
                <span class="choice-number w-6 h-6 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 text-xs">${newIndex}</span>
            </div>
            <div class="col-span-8">
                <input type="text" name="choice_text" placeholder="Choice text"
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
            </div>
            <div class="col-span-2">
                <input type="number" name="choice_score" placeholder="Score" value="0"
                       class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
            </div>
            <div class="col-span-1 flex items-center justify-center">
                <button type="button" class="text-red-500 hover:text-red-700" onclick="removeChoice(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;

        container.appendChild(newChoice);
        updateChoiceNumbers();
    }

    function removeChoice(button) {
        const choiceItem = button.closest('.choice-item');
        const container = document.getElementById('choicesContainer');
        const choiceItems = container.querySelectorAll('.choice-item');

        // Don't remove if it's the last choice
        if (choiceItems.length <= 1) {
            return;
        }

        choiceItem.remove();
        updateChoiceNumbers();
    }

    function updateChoiceNumbers() {
        const container = document.getElementById('choicesContainer');
        const choiceItems = container.querySelectorAll('.choice-item');

        choiceItems.forEach((item, index) => {
            const numberSpan = item.querySelector('.choice-number');
            numberSpan.textContent = index + 1;
        });
    }

    // Function to toggle scoring fields based on is_scored checkbox
    function toggleScoringFields(isScored) {
        console.log('Toggling scoring fields:', isScored);
        const scoringFields = document.getElementById('scoringFields');
        if (scoringFields) {
            if (isScored) {
                scoringFields.classList.remove('hidden');
            } else {
                scoringFields.classList.add('hidden');
            }
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing question form');

        // Set up event listener for question type changes
        const questionTypeSelect = document.getElementById('{{ form.question_type.id_for_label }}');
        if (questionTypeSelect) {
            console.log('Question type select found:', questionTypeSelect.value);
            questionTypeSelect.addEventListener('change', function() {
                console.log('Question type changed to:', this.value);
                toggleQuestionTypeInfo();

                // Update scoring fields based on question type
                const isScorable = ['single_choice', 'multiple_choice', 'scale', 'number'].includes(this.value);
                const isScoredCheckbox = document.getElementById('{{ form.is_scored.id_for_label }}');

                // Show a hint if the question type is scorable
                if (isScorable) {
                    isScoredCheckbox.closest('div').classList.add('border-l-4', 'border-green-400', 'pl-2');
                } else {
                    isScoredCheckbox.closest('div').classList.remove('border-l-4', 'border-green-400', 'pl-2');
                }
            });
        } else {
            console.error('Question type select not found!');
        }

        // Initial setup
        toggleQuestionTypeInfo();

        // Add validation before form submission
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            const questionType = document.getElementById('{{ form.question_type.id_for_label }}').value;

            // For choice questions, ensure we have at least empty inputs for choices
            // The server will create default choices if needed
            if (['single_choice', 'multiple_choice'].includes(questionType)) {
                const choiceInputs = document.querySelectorAll('input[name="choice_text"]');

                // If no choice inputs exist at all, add some default ones
                if (choiceInputs.length === 0) {
                    console.log('No choice inputs found, adding default ones');
                    addChoice();
                    addChoice();
                }

                // Show a warning if no choices have text, but don't prevent submission
                const choiceTexts = Array.from(choiceInputs)
                    .map(input => input.value.trim())
                    .filter(text => text.length > 0);

                if (choiceTexts.length === 0) {
                    console.warn('No choices with text found, default choices will be created');
                    // Just show a warning, don't prevent submission
                    if (confirm('You haven\'t added any choices for this question. Default choices will be created. Continue?')) {
                        return true;
                    } else {
                        event.preventDefault();
                        return false;
                    }
                }
            }

            return true;
        });
    });
</script>
{% endblock %}
